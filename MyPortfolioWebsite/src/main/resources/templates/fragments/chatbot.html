<div th:fragment="chatbotPanel">
  <div id="chat-panel" data-theme="light" 
       style="position:fixed; right:20px; top:120px; 
              width:420px; height:calc(100% - 140px); 
              border-radius:16px; border:3px dashed #000; 
              box-shadow:5px 5px 0 #000; z-index:10000; 
              display:none; flex-direction:column; 
              font-family: 'Press Start 2P', monospace; font-size:1rem;">

    <!-- Header -->
    <div id="chat-header" style="padding:16px; font-weight:bold; text-align:center; font-size:1.5rem;">
      🐱 Chat with Cat
      <span id="close-chat" style="float:right; cursor:pointer; font-size:1.2rem;">✖</span>
    </div>

    <!-- Messages -->
    <div id="chat-messages" 
         style="flex:1; padding:14px; overflow-y:auto; display:flex; flex-direction:column; gap:12px; font-size:1rem; line-height:1.5;">
    </div>

    <!-- Input -->
    <div style="padding:14px; border-top:2px solid #000; display:flex; gap:10px;">
      <input type="text" id="chat-input" placeholder="Type your message..."
             style="flex:1; padding:10px; border:3px solid #000; border-radius:12px; font-size:1rem;">
      <button id="chat-send" 
              style="padding:10px 16px; border:3px solid #000; font-weight:bold; border-radius:12px; cursor:pointer; font-size:1rem;">
        Send
      </button>
    </div>
  </div>

  <script>
  const chatPanel = document.getElementById("chat-panel");
  const chatHeader = document.getElementById("chat-header");
  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");
  const closeChat = document.getElementById("close-chat");

  // Apply theme to chat panel
  function applyChatTheme(theme) {
    chatPanel.dataset.theme = theme;

    if(theme === "light") {
      chatPanel.style.background = "#fff8f0";
      chatPanel.style.borderColor = "#000";
      chatPanel.style.boxShadow = "5px 5px 0 #000";

      chatHeader.style.background = "#ffb6c1";
      chatHeader.style.color = "#3b1f2b";
      chatHeader.style.textShadow = "none";

      chatInput.style.background = "#fff";
      chatInput.style.color = "#000";
      chatInput.style.borderColor = "#000";

      chatSend.style.background = "#ffb6c1";
      chatSend.style.color = "#3b1f2b";
      chatSend.style.borderColor = "#000";
      chatSend.style.boxShadow = "none";

    } else {
      chatPanel.style.background = "#0d0d0d";
      chatPanel.style.borderColor = "#0ff";
      chatPanel.style.boxShadow = "0 0 8px #0ff";

      chatHeader.style.background = "#0ff";
      chatHeader.style.color = "#0d0d0d";
      chatHeader.style.textShadow = "0 0 5px #0ff";

      chatInput.style.background = "#111";
      chatInput.style.color = "#0ff";
      chatInput.style.borderColor = "#0ff";

      chatSend.style.background = "#0ff";
      chatSend.style.color = "#0d0d0d";
      chatSend.style.borderColor = "#0ff";
      chatSend.style.boxShadow = "0 0 5px #0ff";
    }
  }

  // Initialize chat theme based on body class
  applyChatTheme(document.body.classList.contains('dark-theme') ? 'dark' : 'light');

  // Listen to theme toggle changes
  const themeToggle = document.getElementById('theme-toggle');
  themeToggle.addEventListener('change', () => {
    const newTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
    applyChatTheme(newTheme);
  });

  // -----------------------------
  // Open chat panel
  // -----------------------------
  function openChat() {
    chatPanel.style.display = "flex";
    chatInput.focus();
  }

  // Close chat panel
  closeChat.addEventListener("click", () => {
    chatPanel.style.display = "none";
  });

  // -----------------------------
  // Add message
  // -----------------------------
  function addMessage(text, from="cat") {
    const div = document.createElement("div");
    div.style.alignSelf = from==="user" ? "flex-end" : "flex-start";
    div.style.padding = "6px 10px";
    div.style.borderRadius = "12px";

    const theme = chatPanel.dataset.theme;

    if(from === "user") {
      if(theme === "light") {
        div.style.background = "#ffd1dc";
        div.style.color = "#3b1f2b";
      } else {
        div.style.background = "#0ff";
        div.style.color = "#0d0d0d";
      }
    } else {
      if(theme === "light") {
        div.style.background = "#fff0f5";
        div.style.color = "#3b1f2b";
      } else {
        div.style.background = "#111";
        div.style.color = "#0ff";
      }
    }

    div.innerText = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // -----------------------------
  // Send message
  // -----------------------------
  chatSend.addEventListener("click", async () => {
    const msg = chatInput.value.trim();
    if(!msg) return;
    addMessage(msg, "user");
    chatInput.value = "";

    try {
      const response = await fetch("/chatbot?message=" + encodeURIComponent(msg));
      const data = await response.json();
      addMessage(data.reply, "cat");
    } catch(e) {
      addMessage("😿 Error: could not reach the API", "cat");
    }
  });

  chatInput.addEventListener("keypress", (e) => {
    if(e.key==="Enter") chatSend.click();
  });
  </script>
</div>

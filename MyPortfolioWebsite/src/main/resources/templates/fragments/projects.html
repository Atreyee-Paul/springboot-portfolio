<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div th:fragment="projectsSection">
    <section id="projects">
      <!-- Stylized Heading -->
      <div class="projects-heading">
        <h1>MY PROJECTS</h1>
      </div>

      <!-- Floating Carousel Block -->
      <div id="carouselBlock" class="carousel-block"
           onmouseover="this.classList.add('hovered')"
           onmouseout="this.classList.remove('hovered')">
        <!-- Title Row -->
        <div class="carousel-title-row">
          <button onclick="prevProject()">⬅</button>
          <h2 id="projectTitle"></h2>
          <button onclick="nextProject()">➡</button>
        </div>

        <!-- Content Row -->
        <div id="projectContentRow" class="carousel-content-row">
          <img id="projectImage" src="" alt="Project visual">
          <div id="projectDetails"></div>
        </div>
      </div>

      <!-- Bottom Spacer -->
      <div class="projects-bottom-spacer"></div>
    </section>

    <script>
      let projects = [];
      let currentIndex = 0;

	  fetch(`data/projects.json?nocache=${Date.now()}`)
	    .then(res => res.json())
	    .then(data => {
	      projects = data;
	      updateProject();
		  
		  if (window.updateMessage) {
		     updateMessage("projects");
		  }
	    });

		function updateProject() {
		    const project = projects[currentIndex];
		    const isDark = document.body.classList.contains("dark-theme");

		    // Update title and image
		    const imageSrc = isDark ? project.image.dark : project.image.light;
		    document.getElementById("projectTitle").textContent = project.title;
		    document.getElementById("projectImage").src = imageSrc;

		    // Flip layout
		    document.getElementById("projectContentRow").style.flexDirection = currentIndex % 2 === 0 ? "row" : "row-reverse";

		    // Project details
		    const details = document.getElementById("projectDetails");
		    details.innerHTML = `
		        <p style="font-size:1.4em; line-height:1.6;">${project.description}</p>
		        <ul style="margin-top:20px; font-size:1.2em; list-style-type:'🔹'; padding-left:0;">
		            ${project.highlights.map(item => `<li>${item}</li>`).join("")}
		        </ul>
		        <div style="margin-top:25px; font-size:1.1em; font-style:italic;">${project.footer}</div>
		    `;

		    // Add Learn More button
		    const learnMoreBtn = document.createElement(project.status === "completed" ? "a" : "button");
		    learnMoreBtn.textContent = "Go to Project";

		    if (project.status === "completed") {
		        learnMoreBtn.href = project.link;
		        learnMoreBtn.target = "_blank";
		        learnMoreBtn.rel = "noopener noreferrer";
		        Object.assign(learnMoreBtn.style, {
		            display: "inline-block",
		            marginTop: "30px",
		            fontSize: "1.2em",
					background: "linear-gradient(135deg, rgb(206, 255, 245), #f0f0f0)",
		            border: "2px dashed #000",
		            padding: "8px 16px",
		            cursor: "pointer",
		            borderRadius: "8px",
		            boxShadow: "2px 2px 0 #000",
		            textDecoration: "none",
		            color: "#000",
		        });
		    } else {
		        Object.assign(learnMoreBtn.style, {
		            marginTop: "30px",
		            fontSize: "1.2em",
		            backgroundColor: "#fff",
		            border: "2px dashed #000",
		            padding: "8px 16px",
		            cursor: "pointer",
		            borderRadius: "8px",
		            boxShadow: "2px 2px 0 #000",
		        });
		        learnMoreBtn.onclick = () => openModal(project);
		    }

		    details.appendChild(learnMoreBtn);
		}
	  
	  const observer = new MutationObserver(() => {
	    updateProject();
	  });

	  observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

      function nextProject() {
        currentIndex = (currentIndex + 1) % projects.length;
        updateProject();
      }

      function prevProject() {
        currentIndex = (currentIndex - 1 + projects.length) % projects.length;
        updateProject();
      }

	  function openModal(project) {
	      if (project.status === "completed") return; // <-- don't open modal for completed
	      if (document.getElementById("projectModalOverlay")) return;

	    const modal = project.modal;
	    const isDark = document.body.classList.contains("dark-theme");

	    const overlay = document.createElement("div");
	    overlay.id = "projectModalOverlay";
	    overlay.style = `
	      position: fixed;
	      top: 0; left: 0;
	      width: 100vw; height: 100vh;
	      background-color: ${isDark ? "rgba(20,20,20,0.8)" : "rgba(255,255,255,0.8)"};
	      backdrop-filter: blur(6px);
	      z-index: 999;
	      display: flex;
	      align-items: center;
	      justify-content: center;
	    `;

	    const modalBox = document.createElement("div");
	    modalBox.style = `
	      background-color: ${isDark ? "#222" : "#fff"};
	      border: 3px dashed ${isDark ? "#ccc" : "#000"};
	      border-radius: 12px;
	      padding: 40px;
	      max-width: 1000px;
	      width: 92vw;
	      box-shadow: 4px 4px 0 ${isDark ? "#ccc" : "#000"};
	      font-family: 'Comic Neue', cursive;
	      position: relative;
	      display: flex;
	      gap: 40px;
	      flex-direction: row;
	      align-items: flex-start;
	      color: ${isDark ? "#eee" : "#000"};
	    `;

	    const closeBtn = document.createElement("button");
	    closeBtn.textContent = "✖";
	    closeBtn.style = `
	      position: absolute;
	      top: 15px; right: 20px;
	      font-size: 1.4em;
	      background: none;
	      border: none;
	      cursor: pointer;
	      color: ${isDark ? "#ccc" : "#000"};
	    `;

	    const leftBlock = document.createElement("div");
	    leftBlock.style = "flex: 0 0 360px; display: flex; align-items: center; justify-content: center;";

	    let countdownInterval;

	    if (project.status === "completed") {
	      const image = document.createElement("img");
	      image.src = modal.image;
	      image.alt = project.title;
	      image.style = `
	        max-width: 100%;
	        height: auto;
	        border-radius: 10px;
	        box-shadow: 2px 2px 0 ${isDark ? "#ccc" : "#000"};
	        filter: grayscale(100%);
	      `;
	      leftBlock.appendChild(image);
	    } else if (project.status === "ongoing" && project.duration && project.startTime) {
	      const timerBox = document.createElement("div");
	      timerBox.style = `
	        width: 100%;
	        height: 240px;
	        display: flex;
	        align-items: center;
	        justify-content: center;
	        border: 3px dashed ${isDark ? "#ccc" : "#000"};
	        border-radius: 10px;
	        box-shadow: 2px 2px 0 ${isDark ? "#ccc" : "#000"};
	        background: ${isDark ? "#333" : "#fff"};
	        text-align: center;
	      `;

	      const timer = document.createElement("div");
	      timer.style = `
	        font-size: 1.8em;
	        font-weight: bold;
	        color: ${isDark ? "#eee" : "#000"};
	        line-height: 1.4;
	        white-space: pre-line;
	      `;
	      timer.textContent = "⏳ Loading timer...";
	      timerBox.appendChild(timer);
	      leftBlock.appendChild(timerBox);

	      function updateCountdown() {
	        const now = new Date();
	        const start = new Date(Date.parse(project.startTime));
	        if (isNaN(start)) {
	          timer.textContent = "⚠ Invalid start time";
	          return;
	        }

	        const durationMs = project.duration * 24 * 60 * 60 * 1000;
	        let end = new Date(start.getTime() + durationMs);
	        let diff = end - now;

	        if (diff <= 0) {
	          project.startTime = new Date().toISOString();
	          end = new Date(new Date(project.startTime).getTime() + durationMs);
	          diff = end - now;
	        }

	        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
	        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
	        const minutes = Math.floor((diff / (1000 * 60)) % 60);
	        const seconds = Math.floor((diff / 1000) % 60);

	        timer.textContent = `⏳ Time left\n${days}d ${hours}h ${minutes}m ${seconds}s`;
	      }

	      updateCountdown();
	      countdownInterval = setInterval(updateCountdown, 1000);
	    }

	    const details = document.createElement("div");
	    details.style = `
	      flex: 1;
	      text-align: left;
	      font-size: 1.1em;
	      line-height: 1.6;
	      color: ${isDark ? "#eee" : "#000"};
	    `;
	    details.innerHTML = `
	      <h2 style="font-size: 2em; margin-bottom: 10px;">${project.title}</h2>
	      <p style="font-size: 1.2em; margin-bottom: 15px;">${project.description}</p>
	      <div style="font-size: 1.1em; font-weight: bold;">Tools Used:</div>
	      <ul style="padding-left: 20px; margin-bottom: 15px;">
	        ${modal.tools.map(tool => `<li>${tool}</li>`).join("")}
	      </ul>
	      <p style="font-size: 1em;">${modal.notes}</p>
	    `;

		if (project.status === "completed" && project.modal && project.modal.github) {
		  const githubBtn = document.createElement("button");
		  githubBtn.textContent = "🔗 View on GitHub";

		  // Apply styles individually instead of overwriting
		  Object.assign(githubBtn.style, {
		    display: "inline-block",
		    marginTop: "20px",
		    fontSize: "1.2em",
		    fontWeight: "bold",
		    backgroundColor: isDark ? "#444" : "#f0f0f0",
		    color: isDark ? "#eee" : "#000",
		    border: `2px dashed ${isDark ? "#ccc" : "#000"}`,
		    padding: "10px 20px",
		    cursor: "pointer",
		    borderRadius: "8px",
		    boxShadow: `3px 3px 0 ${isDark ? "#ccc" : "#000"}`,
		    transition: "transform 0.1s ease",
		  });

		  githubBtn.onmouseover = () => (githubBtn.style.transform = "scale(1.05)");
		  githubBtn.onmouseout = () => (githubBtn.style.transform = "scale(1)");
		  githubBtn.onclick = () => {
		    window.open(project.modal.github, "_blank");
		  };

		  details.appendChild(githubBtn);
		}

	    closeBtn.onclick = () => {
	      if (countdownInterval) clearInterval(countdownInterval);
	      document.body.removeChild(overlay);
	    };

	    modalBox.appendChild(closeBtn);
	    modalBox.appendChild(leftBlock);
	    modalBox.appendChild(details);
	    overlay.appendChild(modalBox);
	    document.body.appendChild(overlay);
	  }
    </script>
  </div>
</body>
</html>
